# This file was generated by Rigel.
############################################################################

# Use an intermediate stage to clone external repositories without
# compromising the security of any private SSH key.
FROM ros:{{ configuration.distro }} as intermediate

RUN apt clean && apt update && apt install -y \
    git \
{%- if 'melodic' == configuration.distro %}
    python-rosinstall \
    python-vcstool \
{%- else %}
    python3-rosinstall \
    python3-vcstool \
{%- endif %}
    ssh

RUN mkdir -p /root/.ssh/

{% if configuration.ssh is defined and configuration.ssh|length > 0 -%}
# Add SSH keys and set their permissions.
{% for key in configuration.ssh -%}
{%- if key.file == False -%}
ARG {{ key.value }}
{%- endif %}
{%- endfor %}
{%- for key in configuration.ssh %}
{% if key.file -%}
COPY {{ key.value }} /root/.ssh/{{ key.value }}
{%- else -%}
RUN echo "${{ key.value }}" > /root/.ssh/{{ key.value }} && chmod 600 /root/.ssh/{{ key.value }}
{%- endif %}
{%- endfor %}

# Copy SSH configuration file and set its permissions.

{% if configuration.dir is defined and configuration.dir|length -%}
COPY .rigel_config/config /root/.ssh/config
{%- else -%}
COPY config /root/.ssh/config
{%- endif %}
RUN chmod 600 /root/.ssh/config
{%- endif %}

# Ensure hosts are accepted.
RUN touch /root/.ssh/known_hosts
{%- if configuration.ssh is defined and configuration.ssh|length > 0 -%}
{%- for key in configuration.ssh %}
RUN ssh-keyscan {{ key.hostname }} >> /root/.ssh/known_hosts
{%- endfor %}
{%- endif %}
{%- if configuration.hostname is defined and configuration.hostname|length > 0 -%}
{%- for hostname in configuration.hostname %}
RUN ssh-keyscan {{ hostname }} >> /root/.ssh/known_hosts
{%- endfor %}
{%- endif %}

RUN mkdir -p /ros_workspace/src

{% if configuration.rosinstall is defined and configuration.rosinstall|length > 0 %}

# Copy .rosinstall files
{%- for file in configuration.rosinstall %}
COPY {{ file}} /ros_workspace/src/{{ file }}
{%- endfor %}
{%- endif %}

# Clone repositories.
RUN cd /ros_workspace \ 
    && /bin/bash -c "source /opt/ros/{{ configuration.distro }}/setup.bash \
{%- for file in configuration.rosinstall %}
    && vcs import src < src/{{ file }} \
{%- endfor %}
    " && echo

############################################################################

FROM ros:{{ configuration.ros_image }}

{% if configuration.env is defined and configuration.env|length > 0 -%}
# Set required environment variables.
{% for env in configuration.env -%}
ENV {{ env.name }} {{ env.value }}
{% endfor %}
{% endif -%}

# Install dependencies.
RUN sudo apt clean && sudo apt update && sudo apt install -y \
    {% if configuration.apt is defined and configuration.apt|length > 0 -%}
    {% for package in configuration.apt -%}
        {{ package }} \
    {% endfor -%}
    {% endif -%}
    {% if configuration.compiler == 'colcon' -%}
        python3-colcon-common-extensions \
    {% endif -%}
    ssh

{% if configuration.run is defined and configuration.run|length > 0 -%}
# Execute additional commands.
{% for cmd in configuration.run -%}
RUN {{ cmd }}
{% endfor -%}
{%- endif %}

# Create default user '{{ configuration.username }}'.
ARG USERNAME={{ configuration.username }}
RUN groupadd $USERNAME
RUN useradd -ms /bin/bash -g $USERNAME $USERNAME
RUN sh -c 'echo "$USERNAME ALL=(root) NOPASSWD:ALL" >> /etc/sudoers'
USER $USERNAME

# Create ROS workspace folder
RUN mkdir -p /home/{{ configuration.username }}/ros_workspace/src

{%- if configuration.rosinstall is defined and configuration.rosinstall|length > 0 %}

# Copy dependencies from intermediate stage.
COPY --from=intermediate /ros_workspace/src /home/{{ configuration.username }}/ros_workspace/src/

# Give workspace permissions to user
RUN sh -c 'sudo chmod -R +x /home/{{ configuration.username }}/ros_workspace'
RUN sh -c 'sudo chown -R {{ configuration.username }}:{{ configuration.username }} /home/{{ configuration.username }}/ros_workspace'
{%- endif %}

{% if configuration.dir is defined and configuration.dir|length -%}
# Copy this repository into the ROS workspace.
COPY . /home/{{ configuration.username }}/ros_workspace/src/{{ configuration.package }}
{%- endif %}

# Copy bringup script.
{% if configuration.dir is defined and configuration.dir|length -%}
COPY .rigel_config/entrypoint.sh /home/{{ configuration.username }}/robot-entrypoint.sh
{%- else -%}
COPY entrypoint.sh /home/{{ configuration.username }}/robot-entrypoint.sh
{%- endif %}

# Compile ROS workspace.
RUN /bin/bash -c "source /opt/ros/{{ configuration.distro }}/setup.bash \ 
    && cd /home/{{ configuration.username }}/ros_workspace \
    {% if 'core' in configuration.ros_image -%}
        && sudo rosdep init \
    {%- endif %}
    && sudo rosdep fix-permissions \
    && rosdep update \
    && rosdep install --rosdistro {{ configuration.distro }} --from-paths src --ignore-src -r -y \
    {% if configuration.compiler == 'catkin_make' -%}
        && catkin_make"
    {% elif configuration.compiler == 'colcon' -%}
        && colcon build"
    {%- endif %}

# Give permissions to user
RUN sh -c 'sudo chmod +x /home/{{ configuration.username }}/robot-entrypoint.sh'
RUN sh -c 'sudo chown {{ configuration.username }}:{{ configuration.username }} /home/{{ configuration.username }}/robot-entrypoint.sh'

# Launch ROS application.
CMD {{ configuration.command }}
ENTRYPOINT [ "/home/{{ configuration.username }}/robot-entrypoint.sh" ]
